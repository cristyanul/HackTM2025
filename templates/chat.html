<!-- public_resources_map/templates/chat.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AI Assistant • Event Planning Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chat-bubble-user {
      @apply bg-blue-500 text-white rounded-lg p-3 max-w-sm ml-auto;
    }
    .chat-bubble-ai {
      @apply bg-gray-200 text-gray-800 rounded-lg p-3 max-w-lg mr-auto;
    }
    .typing-indicator {
      @apply flex space-x-1;
    }
    .typing-dot {
      @apply w-2 h-2 bg-gray-400 rounded-full animate-pulse;
    }
  </style>
</head>
<body class="h-screen flex flex-col bg-gray-50">

<header class="p-4 bg-gray-800 text-white">
  <div class="flex justify-between items-center">
    <h1 class="text-xl">🤖 AI Event Planning Assistant</h1>
    <div class="flex items-center space-x-4">
      <button id="clearBtn" class="text-sm underline text-white hover:text-gray-300">Clear Conversation</button>
      <a class="underline text-white" href="/">Public Map</a>
      <a class="underline text-white" href="/admin/">Admin</a>
    </div>
  </div>
</header>

<div class="flex-1 flex flex-col max-w-4xl mx-auto w-full">
  <!-- Chat messages area -->
  <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
    <div class="chat-bubble-ai">
      <p class="font-medium text-sm text-gray-600 mb-1">AI Assistant</p>
      <p>👋 Hello! I'm here to help you plan events in Timiș county. I can help you find:</p>
      <ul class="mt-2 text-sm space-y-1">
        <li>🏢 <strong>Venues & Spaces</strong> - halls, conference rooms, outdoor spaces</li>
        <li>🤝 <strong>Volunteers</strong> - NGOs, volunteer organizations</li>
        <li>🤝 <strong>Partners</strong> - companies, institutions for collaboration</li>
        <li>📦 <strong>Logistics</strong> - catering, equipment, transportation</li>
        <li>💰 <strong>Funding</strong> - grants and financial support</li>
        <li>📅 <strong>Events</strong> - networking opportunities, existing events</li>
      </ul>
      <p class="mt-2 text-sm">Try asking something like: <em>"I need a venue for 80 people in Timișoara for a hackathon"</em></p>
    </div>
  </div>

  <!-- Input area -->
  <div class="border-t bg-white p-4">
    <form id="chatForm" class="flex space-x-3">
      <input
        id="messageInput"
        type="text"
        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Ask me about venues, volunteers, partners, logistics, funding..."
        maxlength="500"
      >
      <button
        type="submit"
        id="sendBtn"
        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400"
      >
        Send
      </button>
    </form>
    <p class="text-xs text-gray-500 mt-2">
      💡 Be specific about your event type, location, and requirements for better results.
    </p>
  </div>
</div>

<script>
const chatContainer = document.getElementById('chatContainer');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');

let isLoading = false;
let conversationHistory = []; // Store conversation history

chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const message = messageInput.value.trim();
  if (!message || isLoading) return;

  // Add user message to chat
  addMessage(message, 'user');

  // Add to conversation history
  conversationHistory.push({
    role: 'user',
    content: message
  });

  messageInput.value = '';

  // Show typing indicator
  const typingId = addTypingIndicator();

  // Disable input
  isLoading = true;
  sendBtn.disabled = true;
  sendBtn.textContent = 'Thinking...';

  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message,
        history: conversationHistory
      })
    });

    const data = await response.json();

    // Remove typing indicator
    removeTypingIndicator(typingId);

    if (response.ok) {
      addMessage(data.reply, 'ai', data.resources);

      // Add AI response to conversation history
      conversationHistory.push({
        role: 'assistant',
        content: data.reply
      });
    } else {
      addMessage(`Sorry, I encountered an error: ${data.error}`, 'ai');
    }
  } catch (error) {
    removeTypingIndicator(typingId);
    addMessage('Sorry, I could not process your request. Please try again.', 'ai');
  }

  // Re-enable input
  isLoading = false;
  sendBtn.disabled = false;
  sendBtn.textContent = 'Send';
  messageInput.focus();
});

function addMessage(content, sender, resources = null) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-bubble-${sender}`;

  const senderLabel = document.createElement('p');
  senderLabel.className = 'font-medium text-sm mb-1';
  senderLabel.style.color = sender === 'user' ? 'rgba(255,255,255,0.8)' : '#6b7280';
  senderLabel.textContent = sender === 'user' ? 'You' : 'AI Assistant';

  const contentDiv = document.createElement('div');
  contentDiv.innerHTML = formatMessage(content);

  messageDiv.appendChild(senderLabel);
  messageDiv.appendChild(contentDiv);

  // Add resource breakdown if available
  if (resources && Object.keys(resources).length > 0) {
    const resourcesDiv = document.createElement('div');
    resourcesDiv.className = 'mt-3 text-sm';
    resourcesDiv.innerHTML = formatResources(resources);
    messageDiv.appendChild(resourcesDiv);
  }

  chatContainer.appendChild(messageDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chat-bubble-ai typing-indicator';
  typingDiv.id = 'typing-' + Date.now();

  typingDiv.innerHTML = `
    <p class="font-medium text-sm text-gray-600 mb-1 w-full">AI Assistant</p>
    <div class="flex space-x-1">
      <div class="typing-dot" style="animation-delay: 0ms"></div>
      <div class="typing-dot" style="animation-delay: 150ms"></div>
      <div class="typing-dot" style="animation-delay: 300ms"></div>
    </div>
  `;

  chatContainer.appendChild(typingDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  return typingDiv.id;
}

function removeTypingIndicator(typingId) {
  const typingDiv = document.getElementById(typingId);
  if (typingDiv) {
    typingDiv.remove();
  }
}

function formatMessage(content) {
  // Simple formatting for better readability
  return content
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

function formatResources(resources) {
  let html = '<details class="mt-2"><summary class="cursor-pointer text-blue-600 text-sm">📊 View detailed resource breakdown</summary><div class="mt-2 space-y-2">';

  for (const [type, items] of Object.entries(resources)) {
    if (items.length > 0) {
      html += `<div class="border-l-2 border-blue-200 pl-3">`;
      html += `<h4 class="font-medium text-gray-700">${type} (${items.length})</h4>`;
      html += `<ul class="text-xs space-y-1 mt-1">`;
      items.forEach(item => {
        html += `<li>• <strong>${item.name}</strong>`;
        if (item.city) html += ` - ${item.city}`;
        if (item.capacity) html += ` (capacity: ${item.capacity})`;
        if (item.contact) html += ` - ${item.contact}`;
        html += `</li>`;
      });
      html += `</ul></div>`;
    }
  }

  html += '</div></details>';
  return html;
}

// Clear conversation functionality
clearBtn.addEventListener('click', () => {
  if (confirm('Clear the entire conversation? This cannot be undone.')) {
    conversationHistory = [];
    chatContainer.innerHTML = `
      <div class="chat-bubble-ai">
        <p class="font-medium text-sm text-gray-600 mb-1">AI Assistant</p>
        <p>👋 Hello! I'm here to help you plan events in Timiș county. I can help you find:</p>
        <ul class="mt-2 text-sm space-y-1">
          <li>🏢 <strong>Venues & Spaces</strong> - halls, conference rooms, outdoor spaces</li>
          <li>🤝 <strong>Volunteers</strong> - NGOs, volunteer organizations</li>
          <li>🤝 <strong>Partners</strong> - companies, institutions for collaboration</li>
          <li>📦 <strong>Logistics</strong> - catering, equipment, transportation</li>
          <li>💰 <strong>Funding</strong> - grants and financial support</li>
          <li>📅 <strong>Events</strong> - networking opportunities, existing events</li>
        </ul>
        <p class="mt-2 text-sm">Try asking something like: <em>"I need a venue for 80 people in Timișoara for a hackathon"</em></p>
      </div>
    `;
  }
});

// Focus input on load
messageInput.focus();
</script>

</body>
</html>
