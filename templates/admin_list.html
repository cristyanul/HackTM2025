<!-- public_resources_map/templates/admin_list.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin • List view</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6">
  <header class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-semibold">All Resources</h1>
    <div class="flex items-center space-x-4">
      <label class="text-sm">Filter by category:</label>
      <select id="categoryFilter" class="border px-2 py-1 rounded">
        <option value="">All categories</option>
      </select>
      <a href="/admin/" class="underline">Back to map</a>
      <a href="/chat" class="underline">AI Chat</a>
    </div>
  </header>

  <table class="min-w-full border border-gray-300">
    <thead class="bg-gray-100 text-left">
      <tr>
        <th class="border px-2 py-1">ID</th>
        <th class="border px-2 py-1">Name</th>
        <th class="border px-2 py-1">Type</th>
        <th class="border px-2 py-1">Category</th>
        <th class="border px-2 py-1">City</th>
        <th class="border px-2 py-1">Capacity</th>
        <th class="border px-2 py-1">Contact</th>
        <th class="border px-2 py-1">URL</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="mt-4">
    <button id="loadMore"
            class="px-4 py-2 bg-blue-600 text-white rounded">
      Load more
    </button>
    <span id="noneMsg" class="ml-4 text-gray-600 hidden">
      — no more rows —
    </span>
  </div>

  <script>
    let offset = 0;
    const limit  = 20;
    const tbody  = document.getElementById("tbody");
    const loadBtn= document.getElementById("loadMore");
    const noneMsg= document.getElementById("noneMsg");
    const categoryFilter = document.getElementById("categoryFilter");
    let currentCategory = '';

    // Load categories for filter dropdown
    function loadCategories() {
      fetch('/api/categories')
        .then(r => r.json())
        .then(categories => {
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categoryFilter.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Failed to load categories:', err);
        });
    }

    function addRows(rows){
      rows.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td class="border px-2 py-1">${p.id}</td>
          <td class="border px-2 py-1">${p.name}</td>
          <td class="border px-2 py-1">${p.type}</td>
          <td class="border px-2 py-1">${p.category || 'N/A'}</td>
          <td class="border px-2 py-1">${p.city || 'N/A'}</td>
          <td class="border px-2 py-1">${p.capacity || 'N/A'}</td>
          <td class="border px-2 py-1">${p.contact || 'N/A'}</td>
          <td class="border px-2 py-1">${p.url ? `<a href="${p.url}" target="_blank" class="text-blue-600 underline">Link</a>` : 'N/A'}</td>`;
        tbody.appendChild(tr);
      });
    }

    function load(){
      const categoryParam = currentCategory ? `&category=${encodeURIComponent(currentCategory)}` : '';
      fetch(`/admin/api/resources?offset=${offset}&limit=${limit}${categoryParam}`)
        .then(r=>r.json())
        .then(data=>{
          addRows(data);
          offset += data.length;
          if(data.length < limit){
            loadBtn.disabled = true;
            noneMsg.classList.remove("hidden");
          }
        })
        .catch(err=>{
          console.error(err);
          alert("Failed to load rows. See console for details.");
        });
    }

    function resetAndLoad() {
      // Clear existing rows
      tbody.innerHTML = '';
      offset = 0;
      loadBtn.disabled = false;
      noneMsg.classList.add("hidden");
      load();
    }

    // Category filter change handler
    categoryFilter.addEventListener('change', (e) => {
      currentCategory = e.target.value;
      resetAndLoad();
    });

    // initial setup
    loadCategories();
    load();
    loadBtn.addEventListener("click", load);
  </script>
</body>
</html>
